<!doctype html>
<html lang="en">
<head>
  <!-- /standard (Kim Sze) -->
  <link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
  <link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Method 3 ‚Äî Subtract from the tens, then add the extra (‚Ä¶9) ‚Äî Step-by-step Practice</title>

  <!-- ‚úÖ Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = "https://limkimsze-maker.github.io/SubtractFromTens_AddExtra_Method3/";
    try{
      const toDelete = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) toDelete.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) toDelete.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) toDelete.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) toDelete.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) toDelete.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID+"::")) toDelete.push(k);
        if(k.startsWith("UFCO-")) toDelete.push(k);
      }
      toDelete.forEach(k=>{ try{ localStorage.removeItem(k); }catch(e){} });

      try{
        sessionStorage.removeItem("UFCO-audio-unlocked");
        sessionStorage.removeItem("UFCO-complete");
      }catch(e){}

      try{
        const bc = new BroadcastChannel("xapi-state");
        bc.postMessage({type:"clear", activityId: ACTIVITY_ID, ts: Date.now()});
        bc.close();
      }catch(e){}
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bgA:#f6fbff; --bgB:#fff7ed;
      --card:rgba(255,255,255,.92);
      --ink:#0f172a; --muted:#64748b;
      --line:#e2e8f0;
      --good:#16a34a; --bad:#dc2626; --warn:#f59e0b;
      --accent:#0ea5e9; --accent2:#a855f7;
      --orange:#f59e0b; --blue:#0ea5e9;
      --shadow:0 18px 44px rgba(2,6,23,.12);
      --radius:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}

    html, body{
      width:100%; height:100%; margin:0;
      overflow:hidden;
      position:fixed;
      overscroll-behavior:none;
      touch-action:manipulation;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 5%, rgba(14,165,233,.18), transparent 60%),
        radial-gradient(1200px 700px at 85% 10%, rgba(168,85,247,.14), transparent 60%),
        radial-gradient(900px 500px at 50% 90%, rgba(245,158,11,.10), transparent 62%),
        linear-gradient(180deg, var(--bgA), var(--bgB));
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(45deg,
        rgba(15,23,42,.03) 0 8px,
        rgba(15,23,42,0) 8px 16px);
      pointer-events:none;
      mix-blend-mode:multiply;
      opacity:.28;
    }

    /* Fit-to-viewport wrapper */
    .viewport{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .stageWrap{
      position:relative;
      width: 920px;
      height: 560px;
      overflow:hidden;
    }
    .stage{
      width: 920px;
      height: 560px;
      transform-origin: top left;
      will-change: transform;
      position:absolute; inset:0;
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      padding: 2px 8px 6px 8px;
      height: 42px;
    }
    .title{ font-weight:950; letter-spacing:.2px; line-height:1.05; font-size:17px; }
    .subtitle{ margin-top:2px; color:var(--muted); font-size:10px; line-height:1.15; }
    .badges{
      display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:nowrap;
    }
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      box-shadow:0 10px 22px rgba(2,6,23,.08);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:flex; gap:7px; align-items:center;
      user-select:none;
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--warn); box-shadow:0 0 0 4px rgba(245,158,11,.18); }
    .dot.ok{ background:var(--good); box-shadow:0 0 0 4px rgba(22,163,74,.18); }

    .panel{
      margin: 0 8px 6px 8px;
      height: calc(100% - 48px);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:10px;
      overflow:hidden;
      position:relative;
      backdrop-filter: blur(10px);
    }
    .panel:before{
      content:"";
      position:absolute;
      width:200px; height:200px;
      right:-80px; top:-80px;
      border-radius:56px;
      background: radial-gradient(circle at 30% 30%, rgba(14,165,233,.32), rgba(168,85,247,.16), transparent 70%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .layout{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 170px;
      gap:10px;
      align-items:stretch;
      position:relative;
      z-index:1;
      min-height:0;
      overflow:hidden;
    }

    .mainCard{
      height:100%;
      background: rgba(255,255,255,.94);
      border:1px solid var(--line);
      border-radius:16px;
      padding:8px;
      overflow:hidden;
      display:grid;
      grid-template-rows: auto 1fr;
      gap:8px;
      min-height:0;
    }

    .qHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin:0;
    }
    .eqBig{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:nowrap;
      white-space:nowrap;
      font-weight:950;
      letter-spacing:.2px;
      font-size:22px;
    }
    .eqBig .op{ color:var(--muted); font-weight:900; }
    .hint{
      color:var(--muted);
      font-size:10px;
      line-height:1.15;
      text-align:right;
      max-width: 420px;
    }

    .mid{
      min-height:0;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:10px;
      overflow:hidden;
    }

    .leftBoard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      background:
        radial-gradient(700px 240px at 25% 40%, rgba(14,165,233,.10), transparent 60%),
        radial-gradient(700px 240px at 75% 40%, rgba(168,85,247,.10), transparent 60%),
        rgba(255,255,255,.96);
      overflow:hidden;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:10px;
      min-height:0;
    }

    .bondRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:stretch;
      overflow:hidden;
    }
    .bondBox{
      width:100%;
      height:220px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.06);
      background: radial-gradient(520px 220px at 50% 30%, rgba(255,255,255,.95), rgba(255,255,255,.60));
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .noteBubble{
      border-radius:18px;
      padding:10px 12px;
      background: rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.22);
      color:#14532d;
      font-weight:900;
      font-size:12px;
      line-height:1.2;
      box-shadow:0 10px 18px rgba(2,6,23,.06);
    }

    /* Equation strip: step1 + extra = final */
    .eqStrip{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-weight:950;
      font-size:16px;
      padding:4px 2px;
    }
    .eqStrip .dim{ color:var(--muted); font-weight:900; }

    .finalPill{
      margin-top:auto;
      border-radius:16px;
      padding:12px 12px;
      background: rgba(14,165,233,.08);
      border:1px solid rgba(14,165,233,.18);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      font-weight:950;
      font-size:22px;
      letter-spacing:.2px;
      overflow:hidden;
    }

    .stepsCol{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap:10px;
      overflow:hidden;
      min-height:0;
    }
    .stepCard{
      border-radius:16px;
      background:rgba(255,255,255,.96);
      border:2px solid var(--line);
      padding:10px 10px;
      overflow:hidden;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:6px;
      min-height:0;
    }
    .stepCard.orange{ border-color: rgba(245,158,11,.75); }
    .stepCard.blue{ border-color: rgba(14,165,233,.75); }

    .stepTitle{
      display:flex; gap:8px; align-items:baseline;
      font-weight:950; letter-spacing:.2px;
    }
    .stepTitle .label{ font-size:16px; text-decoration: underline; }
    .stepTitle.orange .label{ color: var(--orange); }
    .stepTitle.blue .label{ color: var(--blue); }

    .stepDesc{ font-weight:900; font-size:13px; color:var(--ink); }

    .stepEq{
      font-weight:950;
      font-size:15px;
      display:grid;
      gap:10px;
      align-content:start;
    }
    .stepEq .row{
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap;
    }
    .stepEq .dim{ color:var(--muted); font-weight:900; }

    /* Inputs */
    input.blank{
      width:74px;
      height:30px;
      border-radius:12px;
      border:2px solid var(--line);
      padding:0 8px;
      font-size:15px;
      font-weight:950;
      text-align:center;
      outline:none;
      background:#fff;
      line-height:30px;
    }
    input.blank.tiny{ width:64px; }
    input.blank:focus{
      border-color: rgba(14,165,233,.75);
      box-shadow:0 0 0 4px rgba(14,165,233,.16);
    }
    .okField{ border-color: rgba(22,163,74,.92)!important; box-shadow:0 0 0 4px rgba(22,163,74,.14)!important; }
    .badField{ border-color: rgba(220,38,38,.92)!important; box-shadow:0 0 0 4px rgba(220,38,38,.12)!important; }

    /* Rail */
    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:13px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(2,6,23,.08);
      white-space:nowrap;
      touch-action:manipulation;
      user-select:none;
    }
    button.primary{
      background:linear-gradient(180deg, rgba(14,165,233,.96), rgba(14,165,233,.82));
      border-color: rgba(14,165,233,.6);
      color:#fff;
    }
    button.good{
      background:linear-gradient(180deg, rgba(22,163,74,.96), rgba(22,163,74,.82));
      border-color: rgba(22,163,74,.6);
      color:#fff;
    }
    button.ghost{ background:rgba(255,255,255,.78); }
    button.warn{
      background:linear-gradient(180deg, rgba(245,158,11,.96), rgba(245,158,11,.82));
      border-color: rgba(245,158,11,.6);
      color:#fff;
    }

    .rail{
      height:100%;
      background: rgba(255,255,255,.94);
      border:1px solid var(--line);
      border-radius:16px;
      padding:9px;
      overflow:hidden;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:8px;
      min-height:0;
    }
    .railTitle{
      font-weight:950;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .railBtns{ display:grid; gap:8px; align-content:start; }
    .railBtns button{
      width:100%;
      padding:10px 10px;
      font-size:12px;
      border-radius:14px;
    }
    .railFooter{ display:grid; gap:8px; }
    .feedback{
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px 9px;
      background: rgba(255,255,255,.88);
      color:var(--muted);
      font-size:10.8px;
      line-height:1.25;
      height:102px;
      overflow:hidden;
    }
    .feedback strong{ color:var(--ink); }
    .creditInline{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
      user-select:none;
    }

    /* Confetti */
    .confetti{
      position:fixed; inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 9999;
    }
    .confetti i{
      position:absolute; top:-12px;
      width:10px; height:14px;
      border-radius:3px;
      opacity:.95;
      animation: fall 1100ms linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(260deg); opacity:1; }
    }

    /* Mobile */
    #panel.smallMode .layout{ grid-template-columns: 1fr; }
    #panel.smallMode .hint{ display:none; }
    #panel.smallMode .mid{ grid-template-columns: 1fr; }
    #panel.smallMode .stepsCol{ grid-template-rows: auto auto; }
    #panel.smallMode .rail{ grid-template-rows: auto auto; height:auto; }
    #panel.smallMode .railBtns{ grid-template-columns: repeat(3, 1fr); gap:8px; }
    #panel.smallMode .railFooter{ grid-template-columns: 1fr 1fr; align-items:stretch; }
    #panel.smallMode .bondBox{ height:200px; }

    #xapiBase{ display:none!important; }

    /* ‚úÖ Back to main menu (fixed bottom-centre, outside stage area) */
    #mainMenuBtn{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(10px + env(safe-area-inset-bottom));
      z-index: 10000;
      padding: 10px 14px;
      font-size: 12px;
      border-radius: 999px;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="viewport">
    <div class="stageWrap" id="stageWrap">
      <div class="stage" id="stage">

        <div class="topbar">
          <div>
            <div class="title">Subtraction Technique 3: Subtract from the Tens, then add the Extra</div>
            <div class="subtitle">Best when the second number ends with 9: do ‚Äú‚àí(next ten)‚Äù, then add the extra.</div>
          </div>
          <div class="badges">
            <div class="pill"><span class="dot" id="statusDot"></span><span id="statusText">Not checked</span></div>
            <div class="pill"><span id="showingText">Showing 0/4</span></div>
            <div class="pill"><span style="font-weight:950">Score</span> <span id="scorePill">0</span></div>
          </div>
        </div>

        <div class="panel" id="panel">
          <div class="layout">

            <!-- MAIN -->
            <div class="mainCard">
              <div class="qHeader">
                <div class="eqBig" aria-label="question equation">
                  <span id="M">84</span>
                  <span class="op">‚àí</span>
                  <span id="S">29</span>
                </div>
                <div class="hint" id="hintText">
                  Tip: Find the <b>next ten</b> of the second number (e.g., 29 ‚Üí 30). Do <b>M ‚àí 30</b> first, then add <b>30 ‚àí 29</b>.
                </div>
              </div>

              <div class="mid">
                <!-- LEFT -->
                <div class="leftBoard">

                  <!-- Number bond: M split into (M - tens) and tens -->
                  <div class="bondRow">
                    <div class="bondBox" aria-label="number bond">
                      <svg viewBox="0 0 520 220" width="100%" height="220" role="img" aria-label="Split M into step1 and tens">
                        <defs>
                          <linearGradient id="gLineG" x1="0" x2="1">
                            <stop offset="0" stop-color="rgba(34,197,94,.95)"/>
                            <stop offset="1" stop-color="rgba(16,185,129,.92)"/>
                          </linearGradient>
                          <radialGradient id="gNodeG" cx="30%" cy="30%">
                            <stop offset="0" stop-color="#ffffff"/>
                            <stop offset="1" stop-color="rgba(240,253,250,0.94)"/>
                          </radialGradient>
                          <filter id="shadowG" x="-30%" y="-30%" width="160%" height="160%">
                            <feDropShadow dx="0" dy="7" stdDeviation="9" flood-color="rgba(2,6,23,0.16)"/>
                          </filter>
                        </defs>

                        <path d="M260 52 C210 86, 170 122, 148 162" fill="none" stroke="url(#gLineG)" stroke-width="10" stroke-linecap="round" opacity="0.9"/>
                        <path d="M260 52 C310 86, 350 122, 372 162" fill="none" stroke="url(#gLineG)" stroke-width="10" stroke-linecap="round" opacity="0.9"/>

                        <!-- TOP M -->
                        <g filter="url(#shadowG)">
                          <circle cx="260" cy="52" r="44" fill="url(#gNodeG)" stroke="rgba(34,197,94,0.55)" stroke-width="8"/>
                          <text x="260" y="60" text-anchor="middle" font-size="26" font-weight="950" fill="#0f172a" id="Mtxt">84</text>
                        </g>

                        <!-- LEFT step1 -->
                        <g filter="url(#shadowG)">
                          <circle cx="148" cy="162" r="52" fill="url(#gNodeG)" stroke="rgba(34,197,94,0.55)" stroke-width="9"/>
                          <text x="148" y="136" text-anchor="middle" font-size="12" font-weight="900" fill="#64748b">after ‚àí tens</text>
                          <foreignObject x="104" y="146" width="88" height="56">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="display:flex;justify-content:center;">
                              <input class="blank tiny" id="bond_step1" inputmode="numeric" autocomplete="off" aria-label="step 1 result in bond">
                            </div>
                          </foreignObject>
                        </g>

                        <!-- RIGHT tens -->
                        <g filter="url(#shadowG)">
                          <circle cx="372" cy="162" r="52" fill="url(#gNodeG)" stroke="rgba(245,158,11,0.55)" stroke-width="9"/>
                          <text x="372" y="136" text-anchor="middle" font-size="12" font-weight="900" fill="#64748b">next ten</text>
                          <foreignObject x="328" y="146" width="88" height="56">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="display:flex;justify-content:center;">
                              <input class="blank tiny" id="bond_tens" inputmode="numeric" autocomplete="off" aria-label="next ten in bond">
                            </div>
                          </foreignObject>
                        </g>
                      </svg>
                    </div>
                  </div>

                  <div class="noteBubble" id="noteBubble">
                    9 is near to 10. If the second number ends with 9, try subtracting the next ten first, then add the extra.
                  </div>

                  <!-- Equation strip (like your Make100 page): step1 + extra = final -->
                  <div class="eqStrip" aria-label="equation strip">
                    <span id="Mstrip">84</span>
                    <span class="dim">‚àí</span>
                    <span id="Sstrip">29</span>
                    <span class="dim">=</span>
                    <input class="blank tiny" id="eq_step1" inputmode="numeric" autocomplete="off" aria-label="step 1 result in strip">
                    <span class="dim">+</span>
                    <input class="blank tiny" id="eq_extra" inputmode="numeric" autocomplete="off" aria-label="extra in strip">
                    <span class="dim">=</span>
                    <input class="blank tiny" id="eq_final" inputmode="numeric" autocomplete="off" aria-label="final in strip">
                  </div>

                  <div class="finalPill" aria-label="final equation">
                    <span id="Mfinal">84</span>
                    <span class="op">‚àí</span>
                    <span id="Sfinal">29</span>
                    <span class="op">=</span>
                    <input class="blank" id="finalAns" inputmode="numeric" autocomplete="off" aria-label="final answer"/>
                  </div>
                </div>

                <!-- RIGHT step cards -->
                <div class="stepsCol" aria-label="step cards">
                  <div class="stepCard orange">
                    <div class="stepTitle orange"><span class="label">STEP 1</span></div>
                    <div class="stepDesc">Subtract the tens from the first number.</div>
                    <div class="stepEq">
                      <div class="row">
                        <span id="Mstep1">84</span>
                        <span class="dim">‚àí</span>
                        <input class="blank tiny" id="s1_tens" inputmode="numeric" autocomplete="off" aria-label="next ten to subtract">
                        <span class="dim">=</span>
                        <input class="blank tiny" id="s1_ans" inputmode="numeric" autocomplete="off" aria-label="step 1 answer">
                      </div>
                    </div>
                  </div>

                  <div class="stepCard blue">
                    <div class="stepTitle blue"><span class="label">STEP 2</span></div>
                    <div class="stepDesc">Add the extra.</div>
                    <div class="stepEq">
                      <div class="row">
                        <input class="blank tiny" id="s2_tens" inputmode="numeric" autocomplete="off" aria-label="next ten again">
                        <span class="dim">‚àí</span>
                        <span id="Sstep2">29</span>
                        <span class="dim">=</span>
                        <input class="blank tiny" id="s2_extra" inputmode="numeric" autocomplete="off" aria-label="extra (tens - S)">
                      </div>
                      <div class="row">
                        <input class="blank tiny" id="s2_step1" inputmode="numeric" autocomplete="off" aria-label="step 1 result again">
                        <span class="dim">+</span>
                        <input class="blank tiny" id="s2_extra2" inputmode="numeric" autocomplete="off" aria-label="extra again">
                        <span class="dim">=</span>
                        <input class="blank tiny" id="s2_final" inputmode="numeric" autocomplete="off" aria-label="final answer in step 2">
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- BUTTON RAIL -->
            <div class="rail" aria-label="controls">
              <div class="railTitle">
                <span>Controls</span>
                <span style="color:var(--muted); font-size:11px;">Step-by-step</span>
              </div>

              <div class="railBtns">
                <button class="primary" id="btnCheck" type="button">Check</button>
                <button class="warn" id="btnNext" type="button">Next ‚ñ∂</button>
                <button class="ghost" id="btnClear" type="button">Clear</button>
                <button class="ghost" id="btnShowAll" type="button">Show all</button>
                <button class="good" id="btnNew" type="button">New</button>
              </div>

              <div class="railFooter">
                <div class="feedback" id="fb">
                  <strong>Goal:</strong> Find the next ten of the second number, do ‚ÄúM ‚àí next ten‚Äù, then add the extra (next ten ‚àí S).
                </div>
                <div class="creditInline">Designed by Lim Kim Sze ¬© 2026</div>
              </div>
            </div>

          </div>

          <div class="confetti" id="confetti"></div>
        </div>

        <!-- Hidden xAPI base -->
        <div id="xapiBase">
          <script src="xapiwrapper.min.js"></script>
          <script src="index.js"></script>
          <div><label>score</label><input id="score-input" value="0"></div>
          <div><label>feedback</label><input id="feedback-input" value="Well done!"></div>
          <button id="sendBtn" type="button">Send/Save</button>
        </div>

      </div>
    </div>
  </div>

  <!-- ‚úÖ Back to the main menu button (centre bottom) -->
  <button id="mainMenuBtn" type="button" aria-label="Back to the main menu">‚¨Ö Back to the main menu</button>

  <!-- Sound kit (generic) -->
  <script>
    let audioCtx = null;
    function ensureAudio(){
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }
    function beep(freq=660, ms=120, type="sine", gainVal=0.06){
      const ctx = ensureAudio();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = gainVal;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(e){} }, ms);
    }
    function sfxCorrect(){ try{ beep(740,110,"triangle",0.07); setTimeout(()=>beep(990,130,"triangle",0.06),120);}catch(e){} }
    function sfxWrong(){ try{ beep(220,180,"sawtooth",0.05);}catch(e){} }
    function sfxClock(){ try{ beep(520,70,"square",0.03);}catch(e){} }
  </script>

  <script>
    const ACTIVITY_ID = "https://limkimsze-maker.github.io/SubtractFromTens_AddExtra_Method3/";
    const $ = (id)=>document.getElementById(id);

    // Problem state
    const state = {
      M:84, S:29,
      tens:30,
      step1:54,
      extra:1,
      final:55
    };

    // Student inputs (NO auto-fill syncing)
    const fieldIds = [
      "bond_step1","bond_tens",
      "eq_step1","eq_extra","eq_final",
      "s1_tens","s1_ans",
      "s2_tens","s2_extra","s2_step1","s2_extra2","s2_final",
      "finalAns"
    ];

    // Reveal plan (Next button) ‚Äî each step can fill multiple blanks
    const revealPlan = [
      { ids:["bond_tens","s1_tens","s2_tens"], val:()=>state.tens, msg:()=>`Find the next ten of ${state.S}.` },
      { ids:["bond_step1","s1_ans","eq_step1","s2_step1"], val:()=>state.step1, msg:()=>`${state.M} ‚àí ${state.tens} = ${state.step1}.` },
      { ids:["s2_extra","s2_extra2","eq_extra"], val:()=>state.extra, msg:()=>`${state.tens} ‚àí ${state.S} = ${state.extra}.` },
      { ids:["s2_final","eq_final","finalAns"], val:()=>state.final, msg:()=>`${state.step1} + ${state.extra} = ${state.final}.` },
    ];
    let nextIndex = 0;

    function lockScroll(){
      try{
        document.addEventListener("wheel", (e)=>{ e.preventDefault(); }, {passive:false});
        document.addEventListener("touchmove", (e)=>{
          const t = e.target;
          if(t && (t.tagName==="INPUT" || t.tagName==="BUTTON")) return;
          e.preventDefault();
        }, {passive:false});
      }catch(e){}
    }

    function scaleStage(){
      const stage = $("stage");
      const wrap  = $("stageWrap");
      const panel = $("panel");
      const viewport = document.querySelector(".viewport");
      const menuBtn = $("mainMenuBtn");

      const vv = window.visualViewport;
      const vw = (vv ? vv.width : window.innerWidth);
      const vh = (vv ? vv.height : window.innerHeight);

      // Reserve space so the fixed bottom button never blocks the stage
      let reserve = 0;
      try{
        if(menuBtn){
          reserve = (menuBtn.getBoundingClientRect().height || 0) + 18;
        }
      }catch(e){}
      try{
        if(viewport) viewport.style.paddingBottom = reserve + "px";
      }catch(e){}

      const designW = 920, designH = 560;
      const margin = 10;

      const usableH = Math.max(200, (vh - reserve));
      const scale = Math.min((vw - margin*2)/designW, (usableH - margin*2)/designH);
      const s = Math.max(0.24, scale);

      wrap.style.width  = (designW * s) + "px";
      wrap.style.height = (designH * s) + "px";
      stage.style.transform = `scale(${s})`;

      const small = (vw < 860) || (s < 0.78);
      panel.classList.toggle("smallMode", small);
    }
    window.addEventListener("resize", scaleStage);
    if(window.visualViewport){
      window.visualViewport.addEventListener("resize", scaleStage);
      window.visualViewport.addEventListener("scroll", scaleStage);
    }

    function clampInt(v){
      if(v === "" || v == null) return null;
      const n = parseInt(String(v).replace(/[^\d\-]/g,""),10);
      return Number.isFinite(n) ? n : null;
    }

    function setStatus(ok, msg){
      $("statusDot").classList.toggle("ok", !!ok);
      $("statusText").textContent = msg;
    }
    function setShowing(){
      const shown = Math.min(nextIndex, revealPlan.length);
      $("showingText").textContent = `Showing ${shown}/${revealPlan.length}`;
    }

    function resetFieldStyles(){
      fieldIds.forEach(id=> $(id).classList.remove("okField","badField"));
    }
    function mark(id, ok){
      const el = $(id);
      el.classList.add(ok ? "okField" : "badField");
      return ok ? 1 : 0;
    }

    function setScore(score, feedback){
      $("scorePill").textContent = String(score);
      const scoreInput = $("score-input");
      const fbInput = $("feedback-input");
      if(scoreInput) scoreInput.value = String(score);
      if(fbInput) fbInput.value = String(feedback || "Well done!");
      try{
        if(typeof storeState === "function"){
          storeState({ score, feedback: String(feedback || "Well done!"), activityId: ACTIVITY_ID, ts: Date.now() });
        }
      }catch(e){}
    }

    function showConfetti(){
      const host = $("confetti");
      host.innerHTML = "";
      for(let i=0;i<42;i++){
        const el = document.createElement("i");
        el.style.left = (Math.random()*100) + "%";
        el.style.animationDuration = (900 + Math.random()*500) + "ms";
        el.style.background = (Math.random() < .5) ? "rgba(14,165,233,.95)" : "rgba(168,85,247,.90)";
        el.style.opacity = (0.75 + Math.random()*0.25).toFixed(2);
        host.appendChild(el);
      }
      setTimeout(()=>{ host.innerHTML=""; }, 1350);
    }

    function updateStaticTexts(){
      $("M").textContent = state.M;
      $("S").textContent = state.S;

      $("Mtxt").textContent = state.M;
      $("Mstrip").textContent = state.M;
      $("Sstrip").textContent = state.S;

      $("Mfinal").textContent = state.M;
      $("Sfinal").textContent = state.S;

      $("Mstep1").textContent = state.M;
      $("Sstep2").textContent = state.S;
    }

    function clearBlanks(){
      fieldIds.forEach(id=> $(id).value = "");
      resetFieldStyles();
      nextIndex = 0;
      setShowing();
      setStatus(false, "Not checked");
      $("fb").innerHTML = "<strong>Cleared.</strong> Fill in the blanks again.";
      setScore(0, "Well done!");
      if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
    }

    function showAllAnswers(){
      // Fill ALL blanks (button-driven), but NO syncing while typing.
      const pairs = [
        ["bond_tens", state.tens], ["s1_tens", state.tens], ["s2_tens", state.tens],
        ["bond_step1", state.step1], ["s1_ans", state.step1], ["eq_step1", state.step1], ["s2_step1", state.step1],
        ["s2_extra", state.extra], ["s2_extra2", state.extra], ["eq_extra", state.extra],
        ["s2_final", state.final], ["eq_final", state.final], ["finalAns", state.final],
      ];
      pairs.forEach(([id,val])=>{ const el=$(id); if(el) el.value=String(val); });

      resetFieldStyles();
      fieldIds.forEach(id=> $(id).classList.add("okField"));
      nextIndex = revealPlan.length;
      setShowing();

      $("fb").innerHTML = `<strong>All shown:</strong> Next ten = ${state.tens}, Step 1 = ${state.step1}, Extra = ${state.extra}, Final = ${state.final}.`;
      setStatus(false, "All answers shown");
      if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
    }

    function revealNext(){
      if(nextIndex >= revealPlan.length){
        setStatus(true, "All steps shown");
        $("fb").innerHTML = "<strong>All shown.</strong> Press Clear to try again, or New for a new question.";
        if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
        setShowing();
        return;
      }
      const step = revealPlan[nextIndex];
      const v = step.val();
      step.ids.forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.value = String(v);
        el.classList.remove("badField");
        el.classList.add("okField");
      });
      $("fb").innerHTML = `<strong>Next:</strong> ${step.msg()}`;
      setStatus(false, `Showing ${nextIndex+1}/${revealPlan.length}`);
      nextIndex++;
      setShowing();
      if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
    }

    function setProblem(M,S){
      state.M = M;
      state.S = S;

      // next ten (e.g., 29 -> 30)
      state.tens = Math.ceil(S/10)*10;
      state.step1 = M - state.tens;
      state.extra = state.tens - S;
      state.final = M - S;

      updateStaticTexts();
      clearBlanks();
      $("fb").innerHTML = "<strong>Goal:</strong> Find the next ten, do ‚ÄúM ‚àí next ten‚Äù, then add the extra.";
    }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function newQuestion(){
      // Choose a 2-digit number ending with 9 (19‚Äì89)
      const tensDigit = randInt(1, 8);
      const S = tensDigit*10 + 9;

      // Ensure M >= next ten (S+1) so Step 1 is not negative; keep 2-digit
      const minM = Math.min(99, Math.ceil(S/10)*10);
      const M = randInt(minM, 99);

      setProblem(M, S);
    }

    function checkAll(){
      resetFieldStyles();

      const vals = {};
      fieldIds.forEach(id=> vals[id] = clampInt($(id).value));

      let okCount = 0;
      const total = fieldIds.length;

      okCount += mark("bond_tens",  vals.bond_tens  === state.tens);
      okCount += mark("s1_tens",    vals.s1_tens    === state.tens);
      okCount += mark("s2_tens",    vals.s2_tens    === state.tens);

      okCount += mark("bond_step1", vals.bond_step1 === state.step1);
      okCount += mark("s1_ans",     vals.s1_ans     === state.step1);
      okCount += mark("eq_step1",   vals.eq_step1   === state.step1);
      okCount += mark("s2_step1",   vals.s2_step1   === state.step1);

      okCount += mark("s2_extra",   vals.s2_extra   === state.extra);
      okCount += mark("s2_extra2",  vals.s2_extra2  === state.extra);
      okCount += mark("eq_extra",   vals.eq_extra   === state.extra);

      okCount += mark("s2_final",   vals.s2_final   === state.final);
      okCount += mark("eq_final",   vals.eq_final   === state.final);
      okCount += mark("finalAns",   vals.finalAns   === state.final);

      if(okCount === total){
        setStatus(true, "‚úÖ All correct!");
        $("fb").innerHTML = "<strong>Correct!</strong> Subtract the next ten, then add the extra. üéâ";
        if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxCorrect();
        showConfetti();
        setScore(1, "Success");
      }else{
        setStatus(false, `Try again (${okCount}/${total} correct)`);
        $("fb").innerHTML = `<strong>Keep going.</strong> Next ten of ${state.S} is ${Math.ceil(state.S/10)*10}. Then do ${state.M} ‚àí next ten, and add the extra.`;
        if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxWrong();
        setScore(0, "Well done!");
      }
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      lockScroll();

      // Back to main menu
      (function(){
        const MAIN_MENU_URL = "https://limkimsze-maker.github.io/P3_Mental_Sum_Challenge/";
        const btn = $("mainMenuBtn");
        if(btn){
          btn.addEventListener("click", ()=>{ window.location.href = MAIN_MENU_URL; });
        }
      })();

      // ‚úÖ Sound by default (resume on first interaction)
      sessionStorage.setItem("UFCO-audio-unlocked","1");
      (function(){
        let armed = false;
        const arm = () => {
          if(armed) return;
          armed = true;
          try{
            const ctx = ensureAudio();
            ctx.resume && ctx.resume().catch(()=>{});
          }catch(e){}
        };
        window.addEventListener("pointerdown", arm, { once:true, capture:true });
        window.addEventListener("keydown", arm, { once:true, capture:true });
      })();

      $("btnCheck").addEventListener("click", checkAll);
      $("btnNext").addEventListener("click", revealNext);
      $("btnClear").addEventListener("click", clearBlanks);
      $("btnShowAll").addEventListener("click", showAllAnswers);
      $("btnNew").addEventListener("click", newQuestion);

      fieldIds.forEach(id=>{
        $(id).addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); checkAll(); }
        });
      });

      scaleStage();
      setProblem(84, 29); // start with the example in your picture
      setShowing();
    });
  </script>
  <script src="https://limkimsze-maker.github.io/assets/nav.js"></script>
</body>
</html>
